name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  id-token: write # Requis pour OIDC
  contents: read  # Requis pour Checkout le code

jobs:
  # ==========================================
  # Scan Global
  # ==========================================
  security_scans:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # (scan l'historique)

      # Gitleaks
      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Checkov
      - name: Checkov Scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/
          framework: terraform
          soft_fail: false # Bloque la pipeline si erreur

      # Trivy Scan
      - name: Trivy Scan (WordPress Image)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'wordpress:6.9.1-php8.5-fpm-alpine'
          format: 'table'
          exit-code: '1' # Bloque la pipeline si failles critiques/hautes
          severity: 'CRITICAL,HIGH'

  # ==========================================
  # TERRAFORM
  # ==========================================
  deploy_infrastructure:
    name: 'Terraform'
    needs: security_scans # Ne s'exécute que si TOUS les scans passent
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    env:
      TF_VAR_my_ip: ${{ secrets.my_ip }}
      TF_VAR_key_name: ${{ secrets.key_name }}
      TF_VAR_db_password: ${{ secrets.db_password }}
      TF_VAR_db_root_password: ${{ secrets.db_root_password }}
      TF_VAR_db_user: ${{ secrets.db_user }}
      TF_VAR_db_name: ${{ secrets.db_name }}
      TF_VAR_id_instance: ${{ secrets.id_instance }}
      TF_VAR_iam_instance_profile: ${{ secrets.iam_instance_profile }}
      TF_VAR_iam_role_arn: ${{ secrets.iam_role_arn }}
      TF_VAR_ght_role_arn: ${{ secrets.ght_role_arn }}
      TF_VAR_ebs_kms_key_arn: ${{ secrets.ebs_kms_key_arn }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GHT_ROLE_ARN }}
          aws-region: eu-west-3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: Terraform Plan
        run: terraform plan -out=tfplan
        working-directory: ./terraform
        
      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        run: terraform apply -auto-approve tfplan
        working-directory: ./terraform

  # ==========================================
  # DÉPLOIEMENT APPLICATIF
  # ==========================================
  deploy_app:
    needs: deploy_infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Get EC2 IP dynamically
        id: get-ip
        run: |
          IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=WordPress-DevSecOps" "Name=instance-state-name,Values=running" \
            --query "Reservations[*].Instances[*].PublicIpAddress" \
            --output text)
          
          echo "EC2_DYNAMIC_IP=$IP" >> $GITHUB_ENV
          echo "L'IP trouvée est : $IP"
        with:
          role-to-assume: ${{ secrets.GHT_ROLE_ARN }}
          aws-region: eu-west-3


      # Déploiement direct car les scans ont déjà été validés à l'étape 1
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_DYNAMIC_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/wordpress
            docker compose pull
            docker compose up -d
